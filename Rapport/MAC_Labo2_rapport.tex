% -----------------------------------------------------------------------
% --- DOCUMENTS ---
% -----------------------------------------------------------------------
\documentclass[11pt, a4paper, french, twoside]{article}
\usepackage[utf8]{inputenc}
\usepackage{ae, pslatex}
\usepackage{listingsutf8}
\usepackage[french]{babel}
\selectlanguage{french} 

\usepackage[table]{xcolor}

\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{pgfplots}
\usepackage{caption}
\usepackage{hyperref}
\hypersetup{
	colorlinks=true,
	linkcolor=blue,
	filecolor=magenta,      
	urlcolor=cyan,
}

\usepackage{titlesec}
\usepackage{color}
\usepackage{colortbl}

\usepackage{hhline,tabu}


\frenchbsetup{StandardLists=true}

\usepackage{etoolbox}


\usepackage{listings} % pour afficher du code
\usepackage{color}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{  
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    backgroundcolor=\color{gray!10},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,
    framexleftmargin = 1em,
    framextopmargin = 1em,
    framexbottommargin=1em, 
    frame=tb, framerule=0pt,
    tabsize=4
}

\lstset{style=mystyle}

% -----------------------------------------------------------------------
% --- MARGES ---sp
% -----------------------------------------------------------------------
\usepackage{vmargin}
\setpapersize{A4}
\setmarginsrb{60pt}{50pt}{60pt}{25pt}{15pt}{25pt}{15pt}{25pt}

% -----------------------------------------------------------------------
% --- EN-TETE ET PIED DE PAGE ---
% -----------------------------------------------------------------------
\usepackage{fancyhdr}
\usepackage{lastpage}
\pagestyle{fancy}

\fancyhead[L]{MAC - Applications multi-tiers}
\fancyhead[R]{IL - TIC - HEIG-VD \\ Automne 2017}
\fancyfoot[C]{\thepage{}}

\title{Applications multi-tiers \\ Laboratoire n\textordmasculine2 : Transactions}
\author{Mathieu Monteverde, Sathiya Kirushnapillai, Michela Zucca}
\date{Automne 2017}

\titlespacing\section{0pt}{12pt plus 4pt minus 2pt}{0pt plus 2pt minus 2pt}
\titlespacing\subsection{0pt}{12pt plus 4pt minus 2pt}{0pt plus 2pt minus 2pt}
\titlespacing\subsubsection{0pt}{12pt plus 4pt minus 2pt}{0pt plus 2pt minus 2pt}


% ***********************************************************************
% *** DOCUMENT PRINCIPAL ***
% ***********************************************************************
\begin{document}
	
	\maketitle
    
    \tableofcontents
	
	\setlength{\parskip}{1em}
	
	\section{Codes implémentés}

    \subsection{SQL}
    Pour ce laboratoire, nous avons désactivé l'auto-commit par défaut de MySQL. Ainsi, nous devons gérer nous-même chaque transaction. 
    
    \lstset{inputencoding=utf8/latin1}
	\lstinputlisting[language=SQL,firstline=190,lastline=191]{../labo2_procedures.sql}
    
    \subsubsection{Transfert 1}
    Nous devons réaliser ce premier transfert sans encadrement \og start transaction commit \fg. Il n'y a rien de particulier à constater. Nous avons simplement rédiger ce code à l'aide du pseudo-code présenté dans la données du laboratoire.
    
    \lstinputlisting[language=SQL,firstline=201,lastline=227]{../labo2_procedures.sql}
    
    \subsubsection{Transfert 2}
    Pour ce transfert, nous avons un code identique au premier transfert ci-dessus. La seule différence est que nous travaillons en mode transactionnel à l'aide de l'encadrement \og start transaction commit \fg. Aucun verrouillage n'a été implémenté.
    
    \lstinputlisting[language=SQL,firstline=240,lastline=267]{../labo2_procedures.sql}
    
    
    \subsubsection{Transfert 3}
    Le code ci-dessous est identique au second transfert. Cependant, nous devons implémenter un verouillage explicite des données sensibles en obéissant au \og verrouillage en deux phases, en verrouillant le plus tard possible. \fg
    
    Pour le verrouillage, on utilise \textit{FOR UPDATE}.
    
    \lstinputlisting[language=SQL,firstline=281,lastline=310]{../labo2_procedures.sql}

    \subsubsection{Transfert 4}
    Cette fois nous opérant un verrouillage des données sensibles en prévenant tout risque d'inter-blocage. On utilise la méthode d'ordonnancement vue en cours. Ainsi, nous ordonnons à l'aide du numéro de compte.

    \lstinputlisting[language=SQL,firstline=328,lastline=366]{../labo2_procedures.sql}

    \subsection{Programme de test Java}
    Comme indiqué dans la consigne, nous avons développé un programme de test java dont les listings se trouvent ci-dessous. Le but du programme est de tester le déroulement des procédures mentionnées plus haut lorsque plusieurs threads concurrents les appellent en même temps.
    
    Le programme est composé de deux classes : \textbf{MAC\_labo2\_part2} et \textbf{TransfertMultiple}. La première est le point d'entrée du programme, et son rôle est de lancer successivement les tests des différentes procédures, en utilisant à tour de rôle les différents modes d'isolations possibles (REPEATABLE READ, READ COMMITTED, READ UNCOMMITTED et SERIALIZABLE). Pour ce faire, elle instancie deux objets de la classe \textbf{TransfertMultiple} qui exécuteront dans des threads séparés des appels aux différentes procédures. 
    
    La class \textbf{TransfertMultiple} ouvre une connexion à la base de données Transactions dans son constructeur, en utilisant l'utilisateur passé en paramètre (se référer au code source plus bas). La méthode \textit{demarrer} effectue les appels dans un thread créé pour l'occasion. Par souci de commodité, cette classe permet également d'autres actions SQL comme l'affichage de l'état des comptes de la base de données et la réinitialisation du soldes des comptes. 
    
    \subsubsection{Listings java}
    \lstinputlisting[language=Java]{../MAC_labo2_part2/src/mac_labo2_part2/MAC_labo2_part2.java}
    \lstinputlisting[language=Java]{../MAC_labo2_part2/src/mac_labo2_part2/TransfertMultiple.java}

	\section{Tests réalisés}
	Les résultats suivants proviennent d'une seule et même exécution du programme de test. Nous avons remarqué des différences dans les temps d'exécution entre les différentes machines et avons choisi d'utiliser la machine la plus rapide. Nous n'avons pas trouvé la cause de ces différences de temps d'exécution qui peuvent, suivant les machines, aller de 3 secondes à presque 10 minutes pour chacune des procédures.
	
	Nous avons utilisé un ordinateur MacBook Pro (Early 2015) possédant les caractéristiques suivantes :
	\begin{itemize}  
		\item OS : MacOS Sierra version 10.12.6  
		\item 2.7 GHz Intel Core i5
	\end{itemize}

	L'installation de la base de données a été faite en utilisant Workbench, en utilisant MySQL avec un moteur de stockage InnoDB.
    
	\subsection{Mode non transactionnel}
	Le premier test concerne l'exécution de la procédure \textbf{transferer1(...)}. Les résultats du test se trouvent dans le tableau ci-dessous. Le mode d'isolation REPEATED READ a été utilisé car il s'agit du mode par défaut de notre installation MySQL.
	
	\subsubsection{Procédure transferer1}
	
	\definecolor{BGray}{gray}{0.60}
	\definecolor{Gray}{gray}{0.85}
	\newcolumntype{a}{>{\columncolor{Gray}}c}
	\begin{tabular}{|a|l|l|l|l|}
		\hline
		\rowcolor{BGray}
		& Repeated Read \\
		\hline
		Nombre d'interblocages      & 0 \\
		\hline
		Temps d'exécution moyen [ms]           & 2770 \\
		\hline
		Solde initial compte A      & 500 \\
		\hline
		Solde initial compte B      & 500 \\
		\hline
		Solde final compte A        & -1700 \\
		\hline
		Solde final compte B        & -2350 \\
		\hline
	\end{tabular}
	
	\subsubsection{Analyse}
	On remarque évidemment qu'il n'y a pas eu d'interblocage, puisque la procédure en question n'utilise pas de verrous. Comme on pouvait s'y attendre, la cohérence des données n'est pas préservée puisque de l'argent a disparu.
	
	On pourra néanmoins utiliser ces temps d'exécution comme valeur étalon pour les tests des autres procédures.
	
	\subsection{Mode transactionnel}
	
	\subsubsection{Procédure transferer2}
    Le tableau ci-dessous liste et permet de comparer les différents résultats des tests de la procédure transferer2.
    
    
    
    \definecolor{BGray}{gray}{0.60}
    \definecolor{Gray}{gray}{0.85}
    \newcolumntype{a}{>{\columncolor{Gray}}c}

    \begin{tabular}{|a|l|l|l|l|}
        \hline
        \rowcolor{BGray}
                                    & Read Uncommitted & Read Committed & Repeatable Read & Serializable \\
        \hline
        Nombre moyen d'interblocages      & 1'796 & 1'622 & 1'636 & 1'892 \\
        \hline
        Temps d'exécution moyen [ms]           & 4'136 & 3'861.5 & 4'271 & 3'941 \\
        \hline
        Solde initial compte A      & 500 & 500 & 500 & 500 \\
        \hline
        Solde initial compte B      & 500 & 500 & 500 & 500 \\
        \hline
        Solde final compte A        & -92'100 & -2'700 & 1'450 & 500 \\
        \hline
        Solde final compte B        & -82'050 & -2'350 & -450 & 500 \\
        \hline
    \end{tabular}

	\subsubsection{Analyse}

	\subsubsection{Procédure transferer3}
	Le tableau ci-dessous liste et permet de comparer les différents résultats des tests de la procédure transferer3.
	
	
	
	\definecolor{BGray}{gray}{0.60}
	\definecolor{Gray}{gray}{0.85}
	\newcolumntype{a}{>{\columncolor{Gray}}c}
	
	\begin{tabular}{|a|l|l|l|l|}
		\hline
		\rowcolor{BGray}
		& Read Uncommitted & Read Committed & Repeatable Read & Serializable \\
		\hline
		Nombre moyen d'interblocages      & 1'690 & 1'518 & 1'701 & 1'606 \\
		\hline
		Temps moyen d'exécution [ms]         & 4'052 & 3'871.5 & 3'938 & 3'922.5 \\
		\hline
		Solde initial compte A      & 500 & 500 & 500 & 500 \\
		\hline
		Solde initial compte B      & 500 & 500 & 500 & 500 \\
		\hline
		Solde final compte A        & 500 & 500 & 500 & 500 \\
		\hline
		Solde final compte B        & 500 & 500 & 500 & 500 \\
		\hline
	\end{tabular}

	\subsubsection{Analyse}


	\subsubsection{Procédure transferer4}
	Le tableau ci-dessous liste et permet de comparer les différents résultats des tests de la procédure transferer4.
	
	
	\definecolor{BGray}{gray}{0.60}
	\definecolor{Gray}{gray}{0.85}
	\newcolumntype{a}{>{\columncolor{Gray}}c}
	
	\begin{tabular}{|a|l|l|l|l|}
		\hline
		\rowcolor{BGray}
		& Read Uncommitted & Read Committed & Repeatable Read & Serializable \\
		\hline
		Nombre moyen d'interblocages      & 0 & 0 & 0 & 0 \\
		\hline
		Temps moyen d'exécution [ms]           & 2'645.5 & 2'820 & 2'855 & 2'800.5 \\
		\hline
		Solde initial compte A      & 500 & 500 & 500 & 500 \\
		\hline
		Solde initial compte B      & 500 & 500 & 500 & 500 \\
		\hline
		Solde final compte A        & 500 & 500 & 500 & 500 \\
		\hline
		Solde final compte B        & 500 & 500 & 500 & 500 \\
		\hline
	\end{tabular}
    
    \subsubsection{Analyse}

\end{document}
